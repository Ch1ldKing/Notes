### **4.1 分页模式和控制位**

**分页行为**由以下控制位决定：

- **CR0**寄存器中的WP和PG标志（分别位于**第16位和第31位**）。
- **CR4**寄存器中的PSE、PAE、PGE、PCIDE和SMEP标志（分别位于**第4位、第5位、第7位、第17位和第20位**）。
- **IA32_EFER** MSR寄存器中的LME和NXE标志（分别位于**第8位和第11位**）。

分页由**CR0.PG**位控制。当**CR0.PG = 0**时，不使用分页，所有线性地址视为物理地址，忽略其他分页控制位。若**CR0.PG = 1**，根据**CR4.PAE和IA32_EFER.LME**的值，系统处于三种分页模式之一。

---

### **4.1.1 三种分页模式**

**分页模式**由CR0.PG、CR4.PAE和IA32_EFER.LME的组合值决定：

- **32位分页**：当CR0.PG = 1且CR4.PAE = 0时。
- **PAE分页**：当CR0.PG = 1，CR4.PAE = 1且IA32_EFER.LME = 0时。
- **IA-32e分页**：当CR0.PG = 1，CR4.PAE = 1且IA32_EFER.LME = 1时。仅支持Intel 64架构。

### **三种分页模式的关键特性**

|分页模式|PG (CR0)|PAE (CR4)|LME (IA32_EFER)|线性地址宽度|物理地址宽度|页大小|是否支持执行禁用？|是否支持PCID？|
|---|---|---|---|---|---|---|---|---|
|无分页|0|不适用|不适用|32位|32位|不适用|否|否|
|32位分页|1|0|0|32位|最多40位|4 KB, 4 MB|否|否|
|PAE分页|1|1|0|32位|最多52位|4 KB, 2 MB|是|否|
|IA-32e分页|1|1|1|48位|最多52位|4 KB, 2 MB, 1 GB|是|是|

---

### **4.1.2 启用和切换分页模式**

分页模式的切换规则：

1. **IA32_EFER.LME**不能在分页启用时修改。若在CR0.PG = 1时尝试修改，将触发**#GP异常**。
2. 若CR4.PAE = 0且IA32_EFER.LME = 1时，无法启用分页，若尝试，将触发**#GP异常**。
3. 切换32位分页和PAE分页：通过修改CR4.PAE实现。
4. 切换IA-32e分页与其他模式：必须先禁用分页（CR0.PG = 0），调整CR4.PAE和IA32_EFER.LME，再重新启用分页。

---

### **4.1.3 分页模式的修饰符**

以下控制位进一步影响分页模式的细节：

- **CR0.WP**：保护页不受超级模式写访问。
- **CR4.PSE**：启用4MB页。
- **CR4.PGE**：启用全局页共享。
- **CR4.PCIDE**：启用PCID（仅IA-32e分页）。
- **CR4.SMEP**：保护超级模式指令不从用户模式地址获取。
- **IA32_EFER.NXE**：启用执行禁用（PAE和IA-32e分页中使用）。

---

### **4.1.4 CPUID指令枚举分页特性**

使用**CPUID**指令可以查询分页特性支持情况，如是否支持4MB页、PAE、全局页、执行禁用等。

---

### **4.2 层次分页结构概述**

所有分页模式使用**层次分页结构**，每个分页结构为4096字节。根据分页模式，每个结构包含不同数量的条目：

- **32位分页**：每个分页结构包含1024个32位条目。
- **PAE分页和IA-32e分页**：每个分页结构包含512个64位条目。

分页转换通过逐级查找结构条目实现，最终定位到物理地址。