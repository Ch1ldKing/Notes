### **4.1 分页模式和控制位**

**分页行为**由以下控制位决定：

- **CR0**寄存器中的WP和PG标志（分别位于**第16位和第31位**）。
- **CR4**寄存器中的PSE、PAE、PGE、PCIDE和SMEP标志（分别位于**第4位、第5位、第7位、第17位和第20位**）。
- **IA32_EFER** MSR寄存器中的LME和NXE标志（分别位于**第8位和第11位**）。

分页由**CR0.PG**位控制。当**CR0.PG = 0**时，不使用分页，所有线性地址视为物理地址，忽略其他分页控制位。若**CR0.PG = 1**，根据**CR4.PAE和IA32_EFER.LME**的值，系统处于三种分页模式之一。


### **4.1.1 三种分页模式**

**分页模式**由CR0.PG、CR4.PAE和IA32_EFER.LME的组合值决定：

- **32位分页**：当CR0.PG = 1且CR4.PAE = 0时。
- **PAE分页**：当CR0.PG = 1，CR4.PAE = 1且IA32_EFER.LME = 0时。
- **IA-32e分页**：当CR0.PG = 1，CR4.PAE = 1且IA32_EFER.LME = 1时。仅支持Intel 64架构。

### **三种分页模式的关键特性**

|分页模式|PG (CR0)|PAE (CR4)|LME (IA32_EFER)|线性地址宽度|物理地址宽度|页大小|是否支持执行禁用？|是否支持PCID？|
|---|---|---|---|---|---|---|---|---|
|无分页|0|不适用|不适用|32位|32位|不适用|否|否|
|32位分页|1|0|0|32位|最多40位|4 KB, 4 MB|否|否|
|PAE分页|1|1|0|32位|最多52位|4 KB, 2 MB|是|否|
|IA-32e分页|1|1|1|48位|最多52位|4 KB, 2 MB, 1 GB|是|是|



### **4.1.2 启用和切换分页模式**

分页模式的切换规则：

1. **IA32_EFER.LME**不能在分页启用时修改。若在CR0.PG = 1时尝试修改，将触发**#GP异常**。
2. 若CR4.PAE = 0且IA32_EFER.LME = 1时，无法启用分页，若尝试，将触发**#GP异常**。
3. 切换32位分页和PAE分页：通过修改CR4.PAE实现。
4. 切换IA-32e分页与其他模式：必须先禁用分页（CR0.PG = 0），调整CR4.PAE和IA32_EFER.LME，再重新启用分页。

### **4.1.3 分页模式的修饰符**

以下控制位进一步影响分页模式的细节：

- **CR0.WP**：保护页不受超级模式写访问。
- **CR4.PSE**：启用4MB页。
- **CR4.PGE**：启用全局页共享。
- **CR4.PCIDE**：启用PCID（仅IA-32e分页）。
- **CR4.SMEP**：保护超级模式指令不从用户模式地址获取。
- **IA32_EFER.NXE**：启用执行禁用（PAE和IA-32e分页中使用）。

### **4.1.4 CPUID指令枚举分页特性**

使用**CPUID**指令可以查询分页特性支持情况，如是否支持4MB页、PAE、全局页、执行禁用等。

### **4.2 层次分页结构概述**

所有分页模式使用**层次分页结构**，每个分页结构为4096字节。根据分页模式，每个结构包含不同数量的条目：

- **32位分页**：每个分页结构包含1024个32位条目。
- **PAE分页和IA-32e分页**：每个分页结构包含512个64位条目。

分页转换通过逐级查找结构条目实现，最终定位到物理地址。

### **4.3 32位分页**

当**CR0.PG = 1**且**CR4.PAE = 0**时，逻辑处理器使用32位分页模式，此时会将**32位线性地址**转换为**40位物理地址**。尽管物理地址范围达到1 TB，但32位线性地址的范围限制在**4 GB**以内。

32位分页通过一系列**分页结构**层级来完成线性地址到物理地址的转换。以下是32位分页的基本流程：

1. **页目录**：位于**CR3寄存器**的31:12位指定的物理地址处，页目录为4 KB对齐，包含1024个32位**页目录项（PDE）**。页目录项的选择方式如下：
    
    - **页目录物理地址的位39:32为0**。
    - **位31:12**来自CR3。
    - **位11:2**来自线性地址的位31:22。
    - **位1:0为0**。
2. **页大小**：页大小由**CR4.PSE**位和**PDE的PS标志（位7）**决定：
    
    - 若**CR4.PSE = 1**且**PDE的PS = 1**，则映射为4 MB页。
    - 若**CR4.PSE = 0**或**PDE的PS = 0**，则使用4 KB的**页表**。
3. **4 KB页映射**：若映射为4 KB页，页目录项的31:12位指向4 KB对齐的页表，页表包含1024个**页表项（PTE）**。PTE的选择方式如下：
    
    - **位39:32为0**。
    - **位31:12**来自PDE。
    - **位11:2**来自线性地址的位21:12。
    - **位1:0为0**。
4. **最终物理地址计算**：
    
    - 若映射为4 MB页，物理地址的**位39:32**来自PDE的位20:13，**位31:22**来自PDE的位31:22，**位21:0**来自线性地址。
    - 若映射为4 KB页，物理地址的**位39:32为0**，**位31:12**来自PTE，**位11:0**来自线性地址。


### **32位分页结构和条目格式**

以下为分页结构和条目的详细格式：

- **CR3格式**：CR3的31:12位指定页目录的物理地址，用于线性地址翻译。
- **页目录项（PDE）格式**：
    - **4 MB页映射**：P位必须为1，PS位必须为1，12位PAT位（若支持）决定内存类型。
    - **页表引用**：P位必须为1，PS位为0。
- **页表项（PTE）格式**：用于映射4 KB页，P位必须为1，PAT位决定内存类型（若支持）。


### **页大小和保留位**

- 若**CR4.PSE = 1**，则有一些保留位限制：
    - 若PDE的P位和PS位均为1，保留位依据**MAXPHYADDR**和**PSE-36机制**决定。
    - 若不支持PAT，则PTE和PDE（PS = 1）中相应位（如位7和位12）为保留位。

### **访问权限**

线性地址成功翻译为物理地址后，访问权限会进行进一步验证