### **4.1 分页模式和控制位**

**分页行为**由以下控制位决定：

- **CR0**寄存器中的WP和PG标志（分别位于**第16位和第31位**）。
- **CR4**寄存器中的PSE、PAE、PGE、PCIDE和SMEP标志（分别位于**第4位、第5位、第7位、第17位和第20位**）。
- **IA32_EFER** MSR寄存器中的LME和NXE标志（分别位于**第8位和第11位**）。

分页由**CR0.PG**位控制。当**CR0.PG = 0**时，不使用分页，所有线性地址视为物理地址，忽略其他分页控制位。若**CR0.PG = 1**，根据**CR4.PAE和IA32_EFER.LME**的值，系统处于三种分页模式之一。


### **4.1.1 三种分页模式**

**分页模式**由CR0.PG、CR4.PAE和IA32_EFER.LME的组合值决定：

- **32位分页**：当CR0.PG = 1且CR4.PAE = 0时。
- **PAE分页**：当CR0.PG = 1，CR4.PAE = 1且IA32_EFER.LME = 0时。
- **IA-32e分页**：当CR0.PG = 1，CR4.PAE = 1且IA32_EFER.LME = 1时。仅支持Intel 64架构。

### **三种分页模式的关键特性**

|分页模式|PG (CR0)|PAE (CR4)|LME (IA32_EFER)|线性地址宽度|物理地址宽度|页大小|是否支持执行禁用？|是否支持PCID？|
|---|---|---|---|---|---|---|---|---|
|无分页|0|不适用|不适用|32位|32位|不适用|否|否|
|32位分页|1|0|0|32位|最多40位|4 KB, 4 MB|否|否|
|PAE分页|1|1|0|32位|最多52位|4 KB, 2 MB|是|否|
|IA-32e分页|1|1|1|48位|最多52位|4 KB, 2 MB, 1 GB|是|是|



### **4.1.2 启用和切换分页模式**

分页模式的切换规则：

1. **IA32_EFER.LME**不能在分页启用时修改。若在CR0.PG = 1时尝试修改，将触发**#GP异常**。
2. 若CR4.PAE = 0且IA32_EFER.LME = 1时，无法启用分页，若尝试，将触发**#GP异常**。
3. 切换32位分页和PAE分页：通过修改CR4.PAE实现。
4. 切换IA-32e分页与其他模式：必须先禁用分页（CR0.PG = 0），调整CR4.PAE和IA32_EFER.LME，再重新启用分页。

### **4.1.3 分页模式的修饰符**

以下控制位进一步影响分页模式的细节：

- **CR0.WP**：保护页不受超级模式写访问。
- **CR4.PSE**：启用4MB页。
- **CR4.PGE**：启用全局页共享。
- **CR4.PCIDE**：启用PCID（仅IA-32e分页）。
- **CR4.SMEP**：保护超级模式指令不从用户模式地址获取。
- **IA32_EFER.NXE**：启用执行禁用（PAE和IA-32e分页中使用）。

### **4.1.4 CPUID指令枚举分页特性**

使用**CPUID**指令可以查询分页特性支持情况，如是否支持4MB页、PAE、全局页、执行禁用等。

### **4.2 层次分页结构概述**

所有分页模式使用**层次分页结构**，每个分页结构为4096字节。根据分页模式，每个结构包含不同数量的条目：

- **32位分页**：每个分页结构包含1024个32位条目。
- **PAE分页和IA-32e分页**：每个分页结构包含512个64位条目。

分页转换通过逐级查找结构条目实现，最终定位到物理地址。

### **4.3 32位分页**

当**CR0.PG = 1**且**CR4.PAE = 0**时，逻辑处理器使用32位分页模式，此时会将**32位线性地址**转换为**40位物理地址**。尽管物理地址范围达到1 TB，但32位线性地址的范围限制在**4 GB**以内。

32位分页通过一系列**分页结构**层级来完成线性地址到物理地址的转换。以下是32位分页的基本流程：

1. **页目录**：位于**CR3寄存器**的31:12位指定的物理地址处，页目录为4 KB对齐，包含1024个32位**页目录项（PDE）**。页目录项的选择方式如下：
    
    - **页目录物理地址的位39:32为0**。
    - **位31:12**来自CR3。
    - **位11:2**来自线性地址的位31:22。
    - **位1:0为0**。
2. **页大小**：页大小由**CR4.PSE**位和**PDE的PS标志（位7）**决定：
    
    - 若**CR4.PSE = 1**且**PDE的PS = 1**，则映射为4 MB页。
    - 若**CR4.PSE = 0**或**PDE的PS = 0**，则使用4 KB的**页表**。
3. **4 KB页映射**：若映射为4 KB页，页目录项的31:12位指向4 KB对齐的页表，页表包含1024个**页表项（PTE）**。PTE的选择方式如下：
    
    - **位39:32为0**。
    - **位31:12**来自PDE。
    - **位11:2**来自线性地址的位21:12。
    - **位1:0为0**。
4. **最终物理地址计算**：
    
    - 若映射为4 MB页，物理地址的**位39:32**来自PDE的位20:13，**位31:22**来自PDE的位31:22，**位21:0**来自线性地址。
    - 若映射为4 KB页，物理地址的**位39:32为0**，**位31:12**来自PTE，**位11:0**来自线性地址。


### **32位分页结构和条目格式**

以下为分页结构和条目的详细格式：

- **CR3格式**：CR3的31:12位指定页目录的物理地址，用于线性地址翻译。
- **页目录项（PDE）格式**：
    - **4 MB页映射**：P位必须为1，PS位必须为1，12位PAT位（若支持）决定内存类型。
    - **页表引用**：P位必须为1，PS位为0。
- **页表项（PTE）格式**：用于映射4 KB页，P位必须为1，PAT位决定内存类型（若支持）。


### **页大小和保留位**

- 若**CR4.PSE = 1**，则有一些保留位限制：
    - 若PDE的P位和PS位均为1，保留位依据**MAXPHYADDR**和**PSE-36机制**决定。
    - 若不支持PAT，则PTE和PDE（PS = 1）中相应位（如位7和位12）为保留位。

### **访问权限**

线性地址成功翻译为物理地址后，访问权限会进行进一步验证

### **4.4 PAE分页模式**

当 **CR0.PG = 1**，**CR4.PAE = 1**，且 **IA32_EFER.LME = 0** 时，逻辑处理器使用 **PAE分页** 模式。PAE分页将 **32位线性地址** 转换为 **52位物理地址**。尽管物理地址可以支持到 **4 PB**，但线性地址空间仍然限制在 **4 GB** 以内。

#### **PAE分页的结构**

PAE分页通过 **4个分页目录指针表条目（PDPTE）** 管理线性地址的翻译，这些条目存储在CR3指向的地址上。与其他分页模式不同的是，每个PDPTE对应一个独立的线性地址空间层级。

#### **PAE分页流程**

1. **PDPTE寄存器**
    
    - **PDPTE寄存器** 存储了 4 个 64位的条目，每个条目控制 **1 GB** 线性地址空间。
    - 若 **PDPTE的P位（bit 0）** 为0，则该条目无效，访问该区域将导致页面错误。
    - 若 **PDPTE的P位** 为1，则会依据 **PDPTE的51:12位** 指定的物理地址找到 **页目录**，每个页目录包含 **512个页目录项（PDE）**。
2. **页目录和页表**
    
    - 页目录的每个PDE控制 **2 MB** 的线性地址空间，其控制方式由 **PS标志（bit 7）** 决定：
        - **若PS=1**：则该PDE直接映射为 **2 MB页**。
            - **物理地址的51:21位** 来自PDE，**位20:0** 来自线性地址。
        - **若PS=0**：则该PDE指向一个4 KB对齐的 **页表**。
            - 页表包含 **512个页表项（PTE）**，每个PTE控制4 KB的地址。
3. **4 KB页映射**
    
    - 若映射为 **4 KB页**，物理地址的 **51:12位** 来自PTE，**位11:0** 来自线性地址。

#### **PDPTE的格式**

|位位置|内容|
|---|---|
|0 (P)|存在位，必须为1以引用页目录|
|1-2|保留位，必须为0|
|3 (PWT)|页面写穿|
|4 (PCD)|页面缓存禁止|
|5-7|保留位|
|8-11|忽略|
|12-51|指向页目录的物理地址|
|52-62|忽略|
|63 (XD)|执行禁止|

#### **访问权限**

PAE分页中的访问权限通过页结构条目的 **U/S位** 和 **R/W位** 控制。若启用了 **IA32_EFER.NXE** 位，还会涉及 **XD位**。

1. **数据读取**
    
    - 对于 **用户模式**，线性地址的所有条目中的 **U/S位** 必须为1。
    - 对于 **超级用户模式**，不要求 U/S位为1。
2. **数据写入**
    
    - **CR0.WP = 1** 时，超级用户模式下写入需要所有条目的 **R/W位** 为1。
    - 用户模式写入同样要求所有条目的 **U/S位** 和 **R/W位** 为1。
3. **指令获取**
    
    - **若IA32_EFER.NXE=1**，执行地址中的 **XD位** 必须为0。

PAE分页通过多级结构高效管理地址翻译并支持更大物理地址空间，为系统提供了更多的内存管理灵活性和保护功能。

### **4.5 IA-32e分页模式**

当 **CR0.PG = 1**、**CR4.PAE = 1** 且 **IA32_EFER.LME = 1** 时，逻辑处理器使用 **IA-32e分页** 模式，此模式将 **48位线性地址** 转换为 **52位物理地址**。尽管物理地址支持到 **4 PB**，但线性地址空间限制在 **256 TB** 以内。

#### **IA-32e分页的结构**

IA-32e分页使用 **4层分页结构** 来翻译线性地址，起始层由CR3寄存器指向的 **PML4表** 决定。若启用了 **PCID（进程上下文标识符）**，CR3的使用方式会有所不同：

- **CR4.PCIDE = 0** 时，CR3的位4:3用于确定PML4表的访问类型。
- **CR4.PCIDE = 1** 时，CR3的位11:0存储PCID。

#### **IA-32e分页流程**

1. **PML4表**
    
    - 位于CR3的 **51:12位** 指定的物理地址处，每个PML4表包含 **512个64位条目（PML4E）**。使用线性地址的 **47:39位** 选择PML4E。
2. **页目录指针表（PDPTE）**
    
    - 每个PML4E指向一个 **4 KB页目录指针表**。PDPTE也包含 **512个条目**，通过线性地址的 **38:30位** 选择。
    - 每个PDPTE控制 **1 GB** 线性地址空间。若 **PS位（bit 7）** 为1，则PDPTE映射为 **1 GB页**；否则，它指向一个页目录。
3. **页目录（PDE）**
    
    - 每个PDPTE可以指向一个 **4 KB页目录**，包含 **512个页目录项（PDE）**。通过线性地址的 **29:21位** 选择PDE。
    - 每个PDE控制 **2 MB** 线性地址空间，若 **PS位** 为1，则PDE映射为 **2 MB页**；否则，它指向一个页表。
4. **页表（PTE）**
    
    - 每个PDE可以指向一个 **4 KB页表**，包含 **512个页表项（PTE）**。通过线性地址的 **20:12位** 选择PTE。
    - 每个PTE映射一个 **4 KB页**。

#### **访问权限控制**

IA-32e分页的访问权限由分页结构条目中的 **U/S位** 和 **R/W位** 控制，若启用了 **IA32_EFER.NXE** 位，还会涉及 **XD位**。

1. **用户模式与超级用户模式**
    
    - **用户模式** 访问需所有分页条目中的 **U/S位** 为1。
    - **超级用户模式** 不要求 U/S位为1。
2. **数据读取和写入**
    
    - 若 **CR0.WP = 1** 时，超级用户模式写入需要 **R/W位** 为1。
    - 用户模式写入需 **U/S位** 和 **R/W位** 均为1。
3. **指令获取**
    
    - 若启用了 **IA32_EFER.NXE** 位，指令获取的线性地址需要 **XD位** 为0。

IA-32e分页模式支持 **4 KB**、**2 MB** 和 **1 GB** 页的映射，使得地址翻译更为灵活，并能够适应较大内存需求。

### **4.6 访问权限**

访问权限控制了线性地址到物理地址转换后的访问行为。是否允许访问由分页结构条目中的权限设置、控制寄存器（CR0、CR4）和IA32_EFER MSR寄存器中的模式修饰符以及访问的模式决定。

#### **访问模式**

每次访问都属于以下两种模式之一：

- **用户模式**：当前特权级（CPL）等于3时的访问。
- **超级用户模式**：CPL小于3的访问。

某些操作会隐式地以超级用户模式访问系统数据结构，例如：

- 访问GDT或LDT以加载段描述符。
- 中断或异常交付时访问IDT。
- 任务切换或CPL更改时访问TSS。

#### **分页对访问权限的控制**

1. **超级用户模式访问**
    
    - **数据读取**：可以从任何线性地址读取数据。
    - **数据写入**：
        - 如果 **CR0.WP = 0**，可以写入任何线性地址。
        - 如果 **CR0.WP = 1**，只能写入R/W标志为1的地址。
    - **指令获取**：
        - 在 **32位分页** 或 **IA32_EFER.NXE = 0** 时，取决于 **CR4.SMEP** 的值：
            - **CR4.SMEP = 0** 时，可以从任何线性地址获取指令。
            - **CR4.SMEP = 1** 时，只能从U/S位为0的地址获取指令。
        - 在 **PAE分页** 或 **IA-32e分页** 且 **IA32_EFER.NXE = 1** 时，取决于 **CR4.SMEP** 的值：
            - **CR4.SMEP = 0** 时，可以从XD位为0的地址获取指令。
            - **CR4.SMEP = 1** 时，U/S位为0且XD位为0时才允许指令获取。
2. **用户模式访问**
    
    - **数据读取**：只能从所有分页结构条目中U/S位为1的地址读取数据。
    - **数据写入**：只有当所有分页结构条目中的 **R/W位** 和 **U/S位** 都为1时，才允许写入。
    - **指令获取**：
        - 在 **32位分页** 或 **IA32_EFER.NXE = 0** 时，只能从所有U/S位为1的地址获取指令。
        - 在 **PAE分页** 或 **IA-32e分页** 且 **IA32_EFER.NXE = 1** 时，只能从U/S位为1且XD位为0的地址获取指令。

#### **缓存与权限控制**

处理器可能会将分页结构中的信息缓存到 **TLB** 和 **分页结构缓存** 中，用于加速权限控制。修改分页结构条目中的权限后，缓存中可能会保留旧权限。

