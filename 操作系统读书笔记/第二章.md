# Preface
## IA-32架构与模式支持

- **IA-32架构**从Intel 386处理器系列开始，为**操作系统**和**系统开发软件**提供了全面支持。
- 这种支持包括多种**运行模式**：
    - **实模式（Real Mode）：** 最基础的模式，类似于老式的8086处理器，只能访问1MB内存。
    - **保护模式（Protected Mode）：** 允许访问更大的内存空间，并提供多种保护机制，用于多任务和进程隔离。
    - **虚拟8086模式（Virtual 8086 Mode）：** 在保护模式下模拟8086处理器的环境，用于运行旧的16位程序。
    - **系统管理模式（System Management Mode，SMM）：** 一种特殊模式，用于电源管理或硬件资源管理。

*这些属于遗留的模式，由于系统开发问题，他们在386之后的处理器上保留了下来*
##  Intel 64 架构及 IA-32e 模式
**Intel 64架构**扩展了IA-32架构，支持**64位环境**，并新增了一种模式：
- **IA-32e模式：** 用于64位程序开发的环境。在这个模式下，存在两种**子模式**：
    - **64位模式（64-bit Mode）：** 支持64位操作系统和应用程序。
    - **兼容模式（Compatibility Mode）：** 允许旧版（32位）的软件在64位操作系统中运行，与64位应用共存。

*该架构拓展原有架构，以支持64位的环境，并且新模式可以兼容老程序*

## 架构中共有的系统级功能
- **内存管理（Memory Management）：** 支持虚拟内存和内存保护。
- **软件模块保护（Protection of Software Modules）：** 通过权限和隔离机制保护进程。
- **多任务（Multitasking）：** 支持多个程序同时运行。
- **异常与中断处理（Exception and Interrupt Handling）：** 管理错误和硬件事件的响应。
- **多处理器支持（Multiprocessing）：** 支持多核或多处理器并行执行。
- **缓存管理（Cache Management）：** 提升性能的缓存优化机制。
- **硬件资源与电源管理（Hardware Resource and Power Management）：** 高效地管理硬件资源和电力消耗。
- **调试与性能监控（Debugging and Performance Monitoring）：** 协助开发者进行系统调试和性能优化。

*首先是最重要的内存机制，包括对内存的虚拟化，通过权限保护内存中进程，隔离进程不受干扰，优化缓存，并且可以对异常进程进行处理。其次是对多处理器的适配，以及可以监控系统性能与硬件资源*
## 模式切换
初始化流程：
通过**系统级指令**与**系统级寄存器**，可以实现模式的切换。通过**上电或复位（reset）** 进行切换**实地址模式**，可以继续通过软件切换到**保护模式**，再从保护模式切换到**IA-32e模式**。

# 2.1 系统架构概览
## 2.1.1 GDT与LDT
 在**保护模式**下，所有内存访问都需要通过**全局描述符表 (GDT)** 或 **局部描述符表 (LDT)** 进行。
 *通过段选择子->(索引GDT,LDT)->段描述符->(GDT,LDT存储)->基地址->(偏移量)->字节位置*
### 段描述符
- **GDT** 和 **LDT** 存储称为**段描述符 (Segment Descriptor)** 的条目。
-  每个段描述符包含：
    - **段的基地址 (Base Address)**：定义段的起始位置。
    - **访问权限 (Access Rights)**：控制对段的访问级别。
    - **段的类型 (Type)**：如代码段、数据段或堆栈段。
    - **使用信息 (Usage Information)**：记录段的用途和状态。
### 段选择子
- 每个段描述符对应一个**段选择子 (Segment Selector)**。
- **段选择子**的功能：
    1. 作为**GDT或LDT中的索引**，指向具体的段描述符（即段描述符在表中的偏移地址）。
    2. 包含一个**全局/局部标志位**，用于指定选择子是指向**GDT**还是**LDT**。
    3. 保存**访问权限信息**，控制段的访问。
### 访问内存字节
- 在访问段中的字节时，需要**段选择子和偏移量**：
    1. 段选择子提供对应段描述符的索引。
    2. 段描述符从**GDT或LDT**中读取，得到段在**线性地址空间**中的**基地址**。
    3. 使用偏移量找到相对于基地址的具体字节位置。
- **段的访问权限**：只有在**当前权限级别 (CPL)** 允许的情况下，才能访问该段中的代码、数据或堆栈。
### GDT和LDT寄存器
- **GDT寄存器 (GDTR)**：存储GDT的**线性基地址**。
- **LDT寄存器 (LDTR)**：存储LDT的**线性基地址**。
*在IA-32e模式下，GDTR和LDTR也相应的被拓展为了64位，进而支持更大的地址空间。*
GDT和LDT是内存管理的核心，它管理**段内存的访问**，并且提供了**访问控制**和**隔离机制**
*值得注意的是，LDT也可以作为段，通过段选择子和段描述符访问，但GDT不行。详见下一部分系统段。*
## 2.1.2 系统段、段描述符、门
### 系统段与系统描述符
除了构成程序或过程执行环境的**代码段、数据段**和**堆栈段**，IA-32架构还定义了两个**系统段**：
- **任务状态段 (TSS, Task-State Segment)**：保存任务的运行状态信息，用于多任务切换。
- **局部描述符表 (LDT, Local Descriptor Table)**：为特定任务提供私有的段描述符表。
*这两个段都可以通过系统段描述符，进行标识和管理。他们的存在是为了管理其他段或任务。*
### 门
*门属于一种描述符，但是比较特殊，打通了不同特权级之间，提供了一个受保护的入口。这样就可以允许代码段访问相同或更高特权级的代码段*？段到底是什么
常见的门类型：
- **调用门 (Call Gate)**：用于访问在更高特权级的代码段中的过程。
- **中断门 (Interrupt Gate)**：处理外部中断事件。
- **陷阱门 (Trap Gate)**：处理陷阱和异常。
- **任务门 (Task Gate)**：用于切换到另一个任务的TSS（但在IA-32e模式中不再支持）。

## 2.1.3 任务状态段 (TSS) 和任务门 (Task Gates)
TSS主要管理任务执行环境的状态，包括以下内容：
- **通用寄存器**和**段寄存器**的状态
- **EFLAGS和EIP寄存器**（用于标志位和指令指针）
- **每个特权级别的堆栈段选择子和堆栈指针**
- **LDT段选择子**（任务关联的局部描述符表）
- **分页结构的基地址**
并且这个TSS的段选择子保存在**任务寄存器**中
而任务门提供**TSS访问的入口**，允许其切换任务。那么是如何切换任务的呢
- 将当前任务的状态保存到其TSS中。
- 将任务寄存器更新为新任务的TSS段选择子。
- 从GDT中访问新任务的TSS段描述符。
- 加载新任务的状态，包括寄存器、LDT选择子、分页控制寄存器CR3、EFLAGS和EIP。
- 执行新任务。
在IA-32e模式中，