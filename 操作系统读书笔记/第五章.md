### 5.1 启用和禁用段级与页级保护
段级保护通过设置CR0寄存器的PE标志进入保护模式后自动启用。在保护模式下，段级保护始终生效，但可以通过设置所有段选择器和描述符的权限级别（DPL）为0，绕过段权限隔离，仅保留段界限检查和类型检查。页级保护在启用分页（CR0寄存器的PG标志被设置）时生效，无法直接关闭，但可以通过清除CR0寄存器的WP标志或将所有页目录和页表条目的读写（R/W）标志及用户/超级用户（U/S）标志设置为允许用户可写，达到绕过保护的效果。
### 5.2 段级和页级保护中使用的字段与标志
段级保护依赖以下字段：描述符类型（S标志）区分系统段与代码/数据段，类型字段（Type）指定段类型，段界限（Limit）定义段大小，粒度标志（G标志）控制单位大小，扩展方向标志（E标志）用于数据段扩展方向，权限级别（DPL、RPL、CPL）定义和控制访问权限。页级保护使用以下字段：用户/超级用户标志（U/S标志）区分页面权限级别，读写标志（R/W标志）控制写访问权限，执行禁用标志（XD标志）控制页面执行权限。
#### 5.2.1 64位模式下的代码段描述符
在64位模式中，代码段描述符的基地址和界限字段被忽略，其他字段继续发挥作用。描述符的第53位（L标志）决定处理器操作模式：L=0为兼容模式，L=1为64位模式，此时CS.D必须为0（默认操作数大小32位，地址大小64位）。权限检查仍基于DPL，与32位模式一致。在IA-32e模式中，设置CS.L和CS.D为非法组合（如L=1，D=1）会触发#GP（一般保护异常）。
### 5.3 段限制检查（Limit Checking）
段描述符中的限制字段（Limit）用于限制程序或过程访问超出段范围的内存地址，其作用由 G 标志（粒度）和 E 标志（扩展方向）决定。G=0（字节粒度）时，限制字段直接表示段的最大偏移地址（0 到 1 MB）；G=1（4 KB 粒度）时，限制字段的值乘以 4 KB，偏移范围扩大至 4 GB，且低 12 位偏移量不参与检查。对于普通数据段，限制字段表示段的最后一个可访问地址；对于扩展向下的数据段，限制字段表示第一个不可访问地址。处理器在访问段时会检查偏移地址和操作范围是否超过限制，超出时抛出 GP 异常，若段为堆栈段（SS），则抛出堆栈故障异常。此外，处理器还对 GDT、IDT、LDT 和 TSS 的描述符表限制字段进行检查，这些限制分别存储在 GDTR、IDTR、LDTR 和任务寄存器中。在 64 位模式下，处理器不对代码段或数据段进行运行时限制检查，但仍会检查描述符表的限制字段。
### 5.4 类型检查（Type Checking）
段描述符的类型信息来自 S 标志和 Type 字段，分别指示描述符为系统段还是代码/数据段，并进一步定义具体类型。处理器在操作段选择器和段描述符时，会检查类型的合法性。例如，CS 寄存器只能加载代码段，SS 寄存器只能加载可写数据段，数据段寄存器（DS、ES、FS、GS）不能加载代码段或系统段。远跳转或调用指令只能访问符合段类型的描述符（如代码段或调用门）。此外，处理器不允许对可执行段写入，只读数据段禁止写入，可执行段需设置可读标志才能读取。在 32 位模式下，将空段选择器加载到 CS 或 SS 会触发 GP 异常，而加载到其他数据段寄存器会导致访问异常；在 64 位模式下，处理器不检查空段选择器，也不会触发异常。
### 5.5 特权级别
处理器定义了 4 个特权级别（0 到 3），数字越大权限越低，级别 0 通常用于操作系统内核，级别 3 用于用户程序。特权级别通过防止低权限程序访问高权限资源来保护系统安全，检测到违规时会触发 GP 异常。特权级别分为三种类型：当前特权级（CPL）存储于 CS 和 SS 寄存器，表示当前执行程序的特权级；描述符特权级（DPL）存储于段描述符中，表示访问特定段或门所需的特权级；请求特权级（RPL）存储于段选择器中，用于覆盖 CPL。在加载段选择器时，处理器会比较 CPL、DPL 和 RPL，只有当 DPL ≥ CPL 且 DPL ≥ RPL 时才允许访问，否则触发 GP 异常。
### 5.6 数据段访问中的特权级检查
处理器访问数据段时，会检查段选择器是否满足特权级规则，需保证 DPL ≥ CPL 且 DPL ≥ RPL。例如，代码段 A（CPL=0）可通过选择器 E1（RPL=0）访问数据段 E（DPL=0），因 CPL 和 RPL 满足条件；代码段 C（CPL=3）则无法通过选择器 E3（RPL=3）访问数据段 E（DPL=2），因 CPL 和 RPL 均高于 DPL。此外，代码段中的数据可通过三种方法访问：加载非符合型或符合型、可读代码段到数据段寄存器；或使用 CS 前缀访问当前 CS 指向的代码段。符合型代码段的特权始终与 CPL 相同，因此无需额外特权检查。
### 5.7 加载 SS 寄存器时的特权级检查
加载 SS（堆栈段）寄存器时，需确保 CPL、RPL 和 DPL 三者相等，才能完成加载，否则触发 GP 异常。这种严格的特权匹配要求确保堆栈的访问权限与当前代码段一致，防止意外或恶意修改堆栈内容。
### 5.8 转移程序控制时的特权检查
程序控制转移通过指令（如 JMP、CALL、RET、SYSENTER、SYSEXIT 等）实现执行流从一个代码段到另一个代码段的切换。处理器在转移过程中会检查段描述符的段界限、类型和特权级（CPL、DPL、RPL）。近跳转/调用仅在当前代码段内切换，无需特权检查；远跳转/调用涉及跨段转移，需验证目标代码段的权限。访问非符合型代码段要求调用者的 CPL 等于目标段的 DPL，而符合型代码段允许调用者 CPL 大于或等于 DPL，且转移后 CPL 保持不变。
#### 通过门描述符的特权控制
门描述符（如调用门、中断门、陷阱门、任务门）提供对不同特权级段的受控访问。调用门用于低特权代码调用高特权代码，门描述符中包含目标段选择器、偏移和访问权限（DPL）。调用门检查调用者 CPL 和 RPL 是否小于或等于门的 DPL，以及目标段的 DPL 是否满足访问规则。调用门常用于内核实现安全的系统服务接口，确保低特权程序无法直接访问高特权资源。
#### 堆栈切换与返回过程
当通过调用门进入更高特权级的非符合型代码段时，处理器自动切换到更高特权级的独立堆栈，以防止低特权级代码干扰。新堆栈的选择器和指针从任务状态段（TSS）中加载，旧堆栈指针被保存并在返回时恢复。在 64 位模式下，不加载新的堆栈段选择器（SS 被设置为 NULL），堆栈切换依赖新栈保存旧栈指针，返回时通过 RET 恢复。RET 指令支持近返回（同段内）和远返回（跨段），若涉及特权切换，处理器需验证目标段的 DPL 是否大于等于当前 CPL，并恢复调用者堆栈。
#### 快速系统调用：SYSENTER/SYSEXIT 和 SYSCALL/SYSRET
SYSENTER 和 SYSEXIT 提供快速系统调用机制，通过特定寄存器（如 IA32_SYSENTER_CS、IA32_SYSENTER_EIP 和 IA32_SYSENTER_ESP）指定目标段和地址，用户态（CPL=3）调用内核态（CPL=0），快速返回用户态。SYSCALL 和 SYSRET 适用于 64 位模式的扁平内存模型，简化保护机制。SYSCALL 转移到内核态，而 SYSRET 返回用户态，状态信息通过寄存器管理（如 R11 保存 RFLAGS）。这些指令通过硬件加速系统调用，减少延迟，同时保证特权级别的安全切换。
### 5.9 特权指令
特权指令用于控制系统功能（如加载系统寄存器），仅允许在 CPL=0（最高权限）下执行，若在其他特权级执行，将触发 GP 异常。这些指令包括段寄存器加载（如 LGDT、LLDT、LTR、LIDT）、控制寄存器操作（如 MOV、LMSW、CLTS）、调试寄存器操作（如 MOV）、缓存和 TLB 操作（如 INVD、WBINVD、INVLPG）以及处理器控制（如 HLT）。性能与计时指令 RDMSR、WRMSR 默认为特权指令，但 RDPMC 和 RDTSC 可通过设置 CR4.PCE 和 TSD 位允许非特权级执行。
### 5.10 指针验证
在保护模式下，处理器验证指针的合法性，以确保段之间的保护和特权级隔离。验证内容包括访问权限（确保段类型与使用兼容）、读写权限（段是否可读或可写）、偏移量（不超出段界限）、提供者权限（验证段选择器的合法性）以及对齐检查（CPL=3 且对齐检查启用时确保指针对齐）。验证工具包括 LAR（检查段访问权限）、VERR/VERW（检查段可读性/可写性）、LSL（检查偏移量是否在段界限内）和 ARPL（调整段选择器的 RPL 以匹配请求者权限）。未对齐访问会触发 AC 异常。
### 5.11 页级保护
页级保护提供对内存访问的细粒度控制，通常用于区分用户态和监督态的访问权限以及保护代码页不被写入。页保护通过 U/S（用户/监督者标志）和 R/W（读/写标志）控制访问权限。U/S 标志指示页面访问权限：0 仅监督者可访问，1 用户和监督者均可访问；R/W 标志指示页面类型：0 只读，1 可读写。在 CPL=0,1,2 时，处理器处于监督模式，可访问所有页面；在 CPL=3 时，处理器处于用户模式，仅可访问用户页面（U/S=1）。若 CR0.WP=1，则监督模式访问也受写保护约束。
页保护的覆盖规则确保当页目录和页表的保护属性不一致时，处理器对每一级结构都进行检查，最终权限取决于两者的组合。此外，某些关键内存访问（如 GDT、LDT、IDT 的段描述符以及特权级切换期间访问的内部堆栈）始终按 CPL=0 处理。页级保护是操作系统隔离和安全机制的重要组成部分。
