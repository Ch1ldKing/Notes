### 5.1 启用和禁用段级与页级保护
段级保护通过设置CR0寄存器的PE标志进入保护模式后自动启用。在保护模式下，段级保护始终生效，但可以通过设置所有段选择器和描述符的权限级别（DPL）为0，绕过段权限隔离，仅保留段界限检查和类型检查。页级保护在启用分页（CR0寄存器的PG标志被设置）时生效，无法直接关闭，但可以通过清除CR0寄存器的WP标志或将所有页目录和页表条目的读写（R/W）标志及用户/超级用户（U/S）标志设置为允许用户可写，达到绕过保护的效果。
### 5.2 段级和页级保护中使用的字段与标志
段级保护依赖以下字段：描述符类型（S标志）区分系统段与代码/数据段，类型字段（Type）指定段类型，段界限（Limit）定义段大小，粒度标志（G标志）控制单位大小，扩展方向标志（E标志）用于数据段扩展方向，权限级别（DPL、RPL、CPL）定义和控制访问权限。页级保护使用以下字段：用户/超级用户标志（U/S标志）区分页面权限级别，读写标志（R/W标志）控制写访问权限，执行禁用标志（XD标志）控制页面执行权限。
#### 5.2.1 64位模式下的代码段描述符
在64位模式中，代码段描述符的基地址和界限字段被忽略，其他字段继续发挥作用。描述符的第53位（L标志）决定处理器操作模式：L=0为兼容模式，L=1为64位模式，此时CS.D必须为0（默认操作数大小32位，地址大小64位）。权限检查仍基于DPL，与32位模式一致。在IA-32e模式中，设置CS.L和CS.D为非法组合（如L=1，D=1）会触发#GP（一般保护异常）。
### 5.3 段限制检查（Limit Checking）
段描述符中的限制字段（Limit）用于限制程序或过程访问超出段范围的内存地址，其作用由 G 标志（粒度）和 E 标志（扩展方向）决定。G=0（字节粒度）时，限制字段直接表示段的最大偏移地址（0 到 1 MB）；G=1（4 KB 粒度）时，限制字段的值乘以 4 KB，偏移范围扩大至 4 GB，且低 12 位偏移量不参与检查。对于普通数据段，限制字段表示段的最后一个可访问地址；对于扩展向下的数据段，限制字段表示第一个不可访问地址。处理器在访问段时会检查偏移地址和操作范围是否超过限制，超出时抛出 GP 异常，若段为堆栈段（SS），则抛出堆栈故障异常。此外，处理器还对 GDT、IDT、LDT 和 TSS 的描述符表限制字段进行检查，这些限制分别存储在 GDTR、IDTR、LDTR 和任务寄存器中。在 64 位模式下，处理器不对代码段或数据段进行运行时限制检查，但仍会检查描述符表的限制字段。
### 5.4 类型检查（Type Checking）
段描述符的类型信息来自 S 标志和 Type 字段，分别指示描述符为系统段还是代码/数据段，并进一步定义具体类型。处理器在操作段选择器和段描述符时，会检查类型的合法性。例如，CS 寄存器只能加载代码段，SS 寄存器只能加载可写数据段，数据段寄存器（DS、ES、FS、GS）不能加载代码段或系统段。远跳转或调用指令只能访问符合段类型的描述符（如代码段或调用门）。此外，处理器不允许对可执行段写入，只读数据段禁止写入，可执行段需设置可读标志才能读取。在 32 位模式下，将空段选择器加载到 CS 或 SS 会触发 GP 异常，而加载到其他数据段寄存器会导致访问异常；在 64 位模式下，处理器不检查空段选择器，也不会触发异常。
### 5.5 特权级别
处理器定义了 4 个特权级别（0 到 3），数字越大权限越低，级别 0 通常用于操作系统内核，级别 3 用于用户程序。特权级别通过防止低权限程序访问高权限资源来保护系统安全，检测到违规时会触发 GP 异常。特权级别分为三种类型：当前特权级（CPL）存储于 CS 和 SS 寄存器，表示当前执行程序的特权级；描述符特权级（DPL）存储于段描述符中，表示访问特定段或门所需的特权级；请求特权级（RPL）存储于段选择器中，用于覆盖 CPL。在加载段选择器时，处理器会比较 CPL、DPL 和 RPL，只有当 DPL ≥ CPL 且 DPL ≥ RPL 时才允许访问，否则触发 GP 异常。
### 5.6 数据段访问中的特权级检查
处理器访问数据段时，会检查段选择器是否满足特权级规则，需保证 DPL ≥ CPL 且 DPL ≥ RPL。例如，代码段 A（CPL=0）可通过选择器 E1（RPL=0）访问数据段 E（DPL=0），因 CPL 和 RPL 满足条件；代码段 C（CPL=3）则无法通过选择器 E3（RPL=3）访问数据段 E（DPL=2），因 CPL 和 RPL 均高于 DPL。此外，代码段中的数据可通过三种方法访问：加载非符合型或符合型、可读代码段到数据段寄存器；或使用 CS 前缀访问当前 CS 指向的代码段。符合型代码段的特权始终与 CPL 相同，因此无需额外特权检查。
### 5.7 加载 SS 寄存器时的特权级检查
加载 SS（堆栈段）寄存器时，需确保 CPL、RPL 和 DPL 三者相等，才能完成加载，否则触发 GP 异常。这种严格的特权匹配要求确保堆栈的访问权限与当前代码段一致，防止意外或恶意修改堆栈内容。
