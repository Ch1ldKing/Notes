### 1. 当执行完 `system_interrupt` 函数，执行 `153` 行 `iret` 时，记录栈的变化情况
1. 打断点`0x9d`，定位到进入task0的语句
2. 单步执行进入int 0x80调用的系统中断
3. 执行到iret命令，记录栈情况![image.png](https://s2.loli.net/2024/11/25/R9OMlden2NKi4VC.png)
4. 执行，记录栈情况![image.png](https://s2.loli.net/2024/11/25/U6HjFpCIlMNvnAu.png)
总结变化情况如下表

| 状态<div style="width:100px"></div> | 栈指针 (ESP) | 栈内容 (从高地址到低地址) | 描述                   |
| --------------------------------- | :-------: | :------------: | -------------------- |
| `iret`前                           |   0xe4c   |     0x10eb     | EIP (返回到指令地址)        |
|                                   |   0xe50   |      0x0f      | CS (代码段选择子)          |
|                                   |   0xe54   |     0x246      | EFLAGS (标志寄存器)       |
|                                   |   0xe58   |     0xbd8      | ESP(用户栈顶指针)          |
| `iret`后                           |   0xbd8   |     0xbd8      | 栈恢复到中断前状态<br>指向用户代码栈 |

我们回到执行`int 0x80`前：
![image.png](https://s2.loli.net/2024/11/25/FsQ1D2AUt9WT4k8.png)
可以看到在进入系统中断前的状态，如下表所示，与系统中断执行iret后的场景一致

| 寄存器<div style="width:380px"></div> | 值<div style="width:280px"></div> |
| :--------------------------------: | :------------------------------: |
|              CS代码段选择子              |               0x0f               |
|              ESP栈顶指针               |              0xbd8               |
|            EFLAGS标志寄存器             |              0x246               |
由此可知iret使寄存器**恢复**到了执行系统中断前的执行上下文，并且执行iret后，EIP指向task0中下一条指令的线性地址
### 2. 当进入和退出 `system_interrupt` 时，都发生了模式切换，请总结模式切换时，特权级是如何改变的？栈切换吗？如何进行切换的？
#### 特权级变化
- 当进入系统中断时，特权级CPL从3到0；退出系统中断时，特权级CPL从0到3
IDT中断门初始化代码如下
```asm
movw $system_interrupt, %ax    # 偏移地址的低 16 位
movw $0xef00, %dx              # 中断门属性
lea idt(,%ecx,8), %esi         # 定位到 IDT 表中对应的描述符位置
movl %eax, (%esi)              # 写入偏移地址低 16 位和段选择子（0x08）
movl %edx, 4(%esi)             # 写入属性字段和偏移地址高 16 位
```
- `0xef00`定义了中断门的属性，最后几位转化为二进制是`1110111100000000`
其中，从左向右数的2,3位为CPL值，为11，即3，表示用户模式可访问该中断门。
- 触发中断后CPU将特权级CPL切换到0，即切换到内核模式。这时会加载内核代码段，CS变为`0x08`，跳转到内核代码执行中断处理
#### 栈切换
进入系统中断前
![image.png](https://s2.loli.net/2024/12/01/FV3MPRTfwDHvtBA.png)
进入系统中断后
![image.png](https://s2.loli.net/2024/12/01/eWjFkUaTxKiR1tJ.png)
可见，保存用户模式的栈状态，然后切换到内核栈，根据TSS0中的定义，将SS切换到`0x10`，ESP切换到内核栈顶指针`krn_stk0`

##### 进入系统中断前后
总结一下
